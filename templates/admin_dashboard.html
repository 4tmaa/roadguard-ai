{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}
{% block header_title %}City Infrastructure Overview{% endblock %}

{% block content %}
<style>
    /* Grid Layout */
    .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
    
    /* Map Section */
    .map-section { 
        background-color: var(--bg-panel); /* Mengikuti tema */
        border-radius: 12px; 
        height: 400px; 
        position: relative; 
        overflow: hidden; 
        border: 1px solid var(--border); 
    }
    .map-overlay { 
        position: absolute; top: 20px; left: 20px; 
        background: rgba(15, 23, 42, 0.8); /* Tetap gelap transparan agar tulisan putih terbaca */
        backdrop-filter: blur(4px); 
        padding: 10px 15px; 
        border-radius: 8px; 
        border: 1px solid rgba(255,255,255,0.1); 
        z-index: 999; 
        color: white; /* Teks overlay tetap putih */
    }
    
    /* Widgets & Cards */
    .right-widgets { display: flex; flex-direction: column; gap: 20px; }
    .widget-card { 
        background-color: var(--bg-panel); /* Mengikuti tema */
        border: 1px solid var(--border); 
        border-radius: 12px; 
        padding: 20px; 
        transition: background-color 0.3s;
    }
    .widget-title { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 15px; font-weight: 600; }
    .big-number { font-size: 36px; font-weight: 700; color: var(--text); margin-bottom: 5px; } /* Warna text ikut tema */
    .trend-badge { background: rgba(16, 185, 129, 0.2); color: var(--green); padding: 2px 8px; border-radius: 4px; font-size: 12px; }
    
    /* Alerts */
    .alert-item { display: flex; align-items: start; gap: 12px; padding-bottom: 12px; margin-bottom: 12px; border-bottom: 1px solid var(--border); }
    .alert-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .alert-icon { color: var(--red); margin-top: 2px; }
    
    /* Table Styles */
    .table-container { 
        background-color: var(--bg-panel); 
        border: 1px solid var(--border); 
        border-radius: 12px; 
        padding: 20px; 
        transition: background-color 0.3s;
    }
    .table-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .custom-table { width: 100%; border-collapse: collapse; }
    .custom-table th { text-align: left; color: var(--text-muted); font-size: 12px; text-transform: uppercase; padding: 15px; border-bottom: 1px solid var(--border); }
    .custom-table td { padding: 15px; color: var(--text); border-bottom: 1px solid var(--border); font-size: 14px; }
    .custom-table tr:hover td { background-color: var(--hover-bg); } /* Hover ikut tema */
    
    /* Badges & Pills */
    .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; }
    .pill-critical { background: rgba(239, 68, 68, 0.15); color: var(--red); border: 1px solid rgba(239, 68, 68, 0.2); }
    .pill-medium { background: rgba(245, 158, 11, 0.15); color: var(--yellow); border: 1px solid rgba(245, 158, 11, 0.2); }
    .pill-low { background: rgba(59, 130, 246, 0.15); color: var(--blue); border: 1px solid rgba(59, 130, 246, 0.2); }
    
    .dot { width: 6px; height: 6px; border-radius: 50%; }
    .dot-red { background: var(--red); }
    .dot-yellow { background: var(--yellow); }
    .dot-blue { background: var(--blue); }
    
    /* Team Status */
    .team-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 13px; }
</style>

<div class="dashboard-grid">
    <div class="map-section" id="map" style="z-index: 1;">
         <div class="map-overlay">
            <i class="fa-solid fa-location-crosshairs text-primary me-2"></i> 
            <span style="font-size: 12px; font-weight: 600;">Live Monitoring</span>
        </div>
    </div>

    <div class="right-widgets">
        <div class="widget-card">
            <div class="widget-title">Total Repairs</div>
            <div class="d-flex justify-content-between align-items-end">
                <div>
                    <div class="big-number">{{ total }}</div>
                    <span class="trend-badge"><i class="fa-solid fa-arrow-trend-up"></i> +12%</span>
                    <span class="text-secondary" style="font-size: 12px;"> vs last week</span>
                </div>
                <i class="fa-solid fa-screwdriver-wrench text-primary" style="font-size: 40px; opacity: 0.2;"></i>
            </div>
            <div class="mt-3" style="height: 4px; background: var(--border); border-radius: 2px;">
                <div style="width: 70%; height: 100%; background: var(--blue); border-radius: 2px;"></div>
            </div>
        </div>

        <div class="widget-card" style="border-left: 3px solid var(--red);">
            <div class="d-flex justify-content-between">
                <div class="widget-title" style="color: var(--red);">PENDING ALERTS</div>
                <i class="fa-solid fa-triangle-exclamation text-danger"></i>
            </div>
            <div class="big-number">{{ berat }}</div>
            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 15px;">Critical Issues Detected</div>

            {% for r in reports %}
                {% if r.priority_score == 3 and r.status != 'Selesai' %}
                <div class="alert-item">
                    <i class="fa-solid fa-circle-exclamation alert-icon"></i>
                    <div>
                        <div style="font-size: 13px; font-weight: 500; color: var(--text);">{{ r.hasil_ai }}</div>
                        <div style="font-size: 11px; color: var(--text-muted);">{{ r.lokasi }}</div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
</div>

<div class="table-container">
    <div class="table-header-row">
        <div style="font-weight: 600; font-size: 16px; color: var(--text);">Active Maintenance Requests</div>
        <div class="d-flex align-items-center gap-2">
            <select id="severityFilter" class="form-select form-select-sm" 
                    style="display: none; width: 150px; background-color: var(--bg-dark); color: var(--text); border-color: var(--border);" 
                    onchange="filterBySeverity()">
                <option value="ALL">Show All</option>
                <option value="Critical">Critical (High)</option>
                <option value="Medium">Medium</option>
                <option value="Low">Low</option>
            </select>
            
            <button class="btn btn-sm btn-outline-secondary" style="border-color: var(--border); color: var(--text-muted);" onclick="toggleFilter()">
                <i class="fa-solid fa-filter me-2"></i>Filter Severity
            </button>
            <a href="{{ url_for('reports_view') }}" class="btn btn-sm btn-primary ms-2">
                <i class="fa-solid fa-expand me-2"></i>View All
            </a>
        </div>
    </div>

    <div class="table-responsive">
        <table class="custom-table" id="dashboardTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>LOCATION</th>
                    <th>SEVERITY</th>
                    <th>VISUAL</th>
                    <th>DATE REPORTED</th>
                    <th>STATUS</th>
                    <th>ACTION</th>
                </tr>
            </thead>
            <tbody>
                {% for r in reports[:5] %}
                <tr>
                    <td style="color: var(--blue);">#{{ r.id.split('_')[1] }}</td>
                    <td style="font-weight: 500;">{{ r.lokasi }}</td>
                    <td>
                        {% if r.priority_score == 3 %}
                            <span class="status-pill pill-critical"><span class="dot dot-red"></span> Critical</span>
                        {% elif r.priority_score == 2 %}
                            <span class="status-pill pill-medium"><span class="dot dot-yellow"></span> Medium</span>
                        {% else %}
                            <span class="status-pill pill-low"><span class="dot dot-blue"></span> Low</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ r.gambar }}" target="_blank">
                            <img src="{{ r.gambar }}" style="width: 30px; height: 30px; border-radius: 4px; border: 1px solid var(--border); object-fit: cover;">
                        </a>
                    </td>
                    <td style="color: var(--text-muted);">{{ r.waktu }}</td>
                    <td>
                        {% if r.status == 'Menunggu' %} <span style="color: var(--text-muted);">Pending</span>
                        {% elif r.status == 'Selesai' %} <span style="color: var(--green);">Resolved</span>
                        {% else %} <span style="color: var(--blue);">In Progress</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="/action/{{ r.id }}/proses" style="color: var(--text-muted); margin-right: 10px;" 
                           data-bs-toggle="tooltip" data-bs-placement="top" title="Dispatch Crew">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </a>
                        <a href="/action/{{ r.id }}/selesai" style="color: var(--green);" 
                           data-bs-toggle="tooltip" data-bs-placement="top" title="Mark as Resolved">
                            <i class="fa-solid fa-check"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="row mt-3">
    <div class="col-md-12">
        <div class="widget-card">
            <div class="widget-title">Team Live Status</div>
            <div class="row">
                {% for team in teams %}
                <div class="col-md-3">
                    <div class="team-row p-2 rounded" style="background: var(--hover-bg); border: 1px solid var(--border);">
                        <span class="fw-bold" style="color: var(--text);">{{ team.name }}</span> 
                        {% if team.status == 'Available' %}
                            <span class="badge bg-success bg-opacity-25 text-success">Available</span>
                        {% elif team.status == 'Busy' %}
                            <span class="badge bg-secondary bg-opacity-25 text-secondary">Busy</span>
                        {% else %}
                            <span class="badge bg-warning bg-opacity-25 text-warning">Maint.</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- 1. LOGIKA PETA AGAR BERUBAH WARNA ---
    var map = L.map('map').setView([-6.2088, 106.8456], 12); 

    // Cek apakah mode terang aktif di localStorage
    var isLight = localStorage.getItem('theme') === 'light';
    
    // URL Tile Layer (Gelap vs Terang)
    var darkTiles = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
    var lightTiles = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
    
    // Pilih tile berdasarkan mode
    var tileUrl = isLight ? lightTiles : darkTiles;

    L.tileLayer(tileUrl, {
        attribution: '&copy; OpenStreetMap &copy; CARTO',
        subdomains: 'abcd', maxZoom: 19
    }).addTo(map);

    // Marker Logic
    var reports = {{ reports | tojson }};
    reports.forEach(function(r) {
        var color = '#3b82f6';
        if (r.priority_score == 3) color = '#ef4444';
        else if (r.priority_score == 2) color = '#f59e0b';
        L.circleMarker([r.lat, r.lng], { color: color, fillColor: color, fillOpacity: 0.8, radius: 6 })
         .addTo(map)
         .bindPopup(`<div style="color:black"><b>${r.lokasi}</b><br>${r.hasil_ai}</div>`);
    });

    // --- 2. FUNGSI FILTER ---
    function toggleFilter() {
        var input = document.getElementById("severityFilter");
        if (input.style.display === "none") {
            input.style.display = "block";
            input.focus();
        } else {
            input.style.display = "none";
        }
    }

    function filterBySeverity() {
        var select = document.getElementById("severityFilter");
        var filter = select.value.toUpperCase();
        var table = document.getElementById("dashboardTable");
        var tr = table.getElementsByTagName("tr");

        for (var i = 1; i < tr.length; i++) {
            var td = tr[i].getElementsByTagName("td")[2]; // Kolom Severity
            if (td) {
                var txtValue = td.textContent || td.innerText;
                if (filter === "ALL") {
                    tr[i].style.display = "";
                } else if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }       
        }
    }
</script>
{% endblock %}